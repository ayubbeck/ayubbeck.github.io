<!DOCTYPE html>
<html lang="en">
<head>
  <title>CO2 Emission</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <style>
    #outer-div {
      width: 100%;
      text-align: center;
    }
    #inner-div {
      display: inline-block;
      margin: 0 auto;
      padding: 3px;
    }
    div.tooltip {
      position: absolute;
      text-align: left;
      padding: 5px;
      border-radius: 5px;
      box-shadow: 1px 1px 1px 1px grey;
    }
  </style>
  <script type="text/javascript">
    var prev = 0
    show = (id) => {
      var pages = document.getElementsByClassName("pages")
      Array.from(pages).forEach((page) => {
        page.style.display = 'none'
      })
      var e = document.getElementById(id);
      e.style.display = 'block'
      if (id == 1) {
        chart_one()
      } else if (id == 2) {
        topEmission('coal',4,'Top Countries, CO2 Emission From Coal',9,'billion','chart-2')
      } else if (id == 3) {
        topEmission('oil',4,'Top Countries, CO2 Emission From Oil',9,'billion','chart-3')
      } else {
        topEmission('gas',4,'Top Countries, CO2 Emission From Gas',6,'million','chart-4')
      }
      var pages = document.getElementsByClassName("page-item")
      Array.from(pages).forEach((page) => {
        page.classList.remove("active")
      })
      var e = document.getElementById("li-" + id);
      e.classList.add("active")
      prev = id
    }
    previous = () => {
      if ((prev - 1) > 0) {
        show((prev - 1))
      }
    }
    next = () => {
      if ((prev + 1) <= 4) {
        show((prev + 1))
      }
    }
  </script>
</head>
<body onload="show(1)">
  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center">
      <li class="page-item"><a class="page-link" href="#" onclick="previous()">Previous</a></li>
      <li id="li-1" class="page-item"><a class="page-link" href="#" onclick="show(1)">1</a></li>
      <li id="li-2" class="page-item"><a class="page-link" href="#" onclick="show(2)">2</a></li>
      <li id="li-3" class="page-item"><a class="page-link" href="#" onclick="show(3)">3</a></li>
      <li id="li-4" class="page-item"><a class="page-link" href="#" onclick="show(4)">4</a></li>
      <li class="page-item"><a class="page-link" href="#" onclick="next()">Next</a></li>
    </ul>
  </nav>
  <div id="outer-div">
    <div id="inner-div">
      <div id="1" class="pages">
        <svg id="chart-1" width="800" height="600"></svg>
      </div>
      <div id="2" class="pages">
        <svg id="chart-2" width="800" height="600"></svg>
      </div>
      <div id="3" class="pages">
        <svg id="chart-3" width="800" height="600"></svg>
      </div>
      <div id="4" class="pages">
        <svg id="chart-4" width="800" height="600"></svg>
      </div>
      <div id='tooltip' class="tooltip"></div>
    </div>
  </div>
</body>
<script src='https://d3js.org/d3.v5.min.js'></script>

<script>
  topEmission = (fuelType,topCountries,title,power,sign,chartId) => {
    const color = ["#ff0000","#13155e","#c86000","#009B77","#0049B7"]
    var svg = d3.select("#"+chartId)
    const tooltip = d3.select('#tooltip')
    const tooltipLine = svg.append('line')
    const margin = {top:50, right:100, bottom:50, left:100}
    const width = svg.attr("width") - margin.left - margin.right
    const height = svg.attr("height") - margin.top - margin.bottom
    const x = d3.scaleLinear().range([0, width])
    const y = d3.scaleLinear().range([height, 0])

    svg.append("text")
    .attr("transform", "translate(" + (width/2+margin.left) + " ," + 30 + ")")
    .style("text-anchor", "middle")
    .style("font", "20px avenir")
    .text(title)

    const line = d3.line().x(d => margin.left + x(d.year)).y(d => margin.bottom + y(d.emission)).curve(d3.curveMonotoneX)
    var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    let fuel, tipBox
    d3.csv("data/co2-emissions-by-fuel-line.csv").then((data) => {
      fuel = []
      var country = {}
      data.forEach((d, i) => {
        if (Number(d["year"]) >= 1900 && d["code"] != "OWID_WRL") {
          if (!country.hasOwnProperty(d["code"])) {
            country[d["code"]] = {"name":d["entity"],"currentEmission":0,"history":[]}
          }
          country[d["code"]]["history"].push({ "year":Number(d["year"]),"emission":Number(d[fuelType]) })
          country[d["code"]]["currentEmission"] = Number(d[fuelType])
        }
      })
      Object.keys(country).forEach((item, i) => {
        fuel.push(country[item])
      })
      fuel = fuel.sort((a, b) => (a.currentEmission > b.currentEmission) ? -1 : 1).slice(0,topCountries)
      fuel.forEach((item, i) => {
        item["color"] = color[i]
      })
      // domains
      const minYear = d3.min(fuel,(d) => {return d3.min(d["history"], (d) => {return d["year"]})})
      const maxYear = d3.max(fuel,(d) => {return d3.max(d["history"], (d) => {return d["year"]})})
      x.domain([minYear,maxYear])
      y.domain([0,d3.max(fuel, (d) => { return  d3.max(d["history"], (d) => {return d["emission"]}) })])
      // populate x axis labels
      g.append("g")
    	.attr("transform", "translate(0," + height + ")")
    	.call(d3.axisBottom(x).tickValues([minYear,1925,1950,1975,2000,maxYear]).tickFormat(d3.format("d")))
      // text label for the x axis
      svg.append("text")
      .attr("transform", "translate(" + (width/2+margin.left) + " ," + (height + 2*margin.top) + ")")
      .style("text-anchor", "middle")
      .style("font", "16px avenir")
      .text("Year")
      // populate y axis labels
      g.append("g")
      .call(d3.axisLeft(y).tickFormat((d) => {return d3.format(",.2r")(d/Math.pow(10,power)) + ' ' + sign}))
      // draw line
      svg.selectAll()
        .data(fuel).enter()
        .append('path')
        .attr('fill', 'none')
        .attr('stroke', d => d["color"])
        .attr('stroke-width', 1.5)
        .datum(d => d["history"])
        .attr('d', line)
      // add type of fuel
      svg.selectAll()
        .data(fuel).enter()
        .append('text')
        .html(d => d["name"])
        .attr('fill', d => d["color"])
        .attr('alignment-baseline', 'middle')
        .attr('x', width + margin.left)
        .attr('dx', '.5em')
        .attr('y', d => margin.bottom  + y(d["currentEmission"]))
      // add type of tipBox
      tipBox = svg.append('rect')
        .attr('x',margin.left)
        .attr('y',margin.bottom)
        .attr('width', width)
        .attr('height', height)
        .attr('opacity', 0)
        .on('mousemove', drawTooltip)
        .on('mouseout', removeTooltip)
    })
    removeTooltip = () => {
      if (tooltip) tooltip.style('display', 'none')
      if (tooltipLine) tooltipLine.attr('stroke', 'none')
    }
    drawTooltip = () => {
      const year = Math.ceil(x.invert(d3.mouse(tipBox.node())[0]-margin.left))
      fuel.sort((a, b) => {
        var aFind = a.history.find(h => h.year == year)
        var bFind = b.history.find(h => h.year == year)
        if (aFind && bFind) {
          return bFind.emission - aFind.emission;
        }
        else {
          return 0
        }
      })
      tooltipLine.attr('stroke', 'lightgrey')
        .attr('x1', x(year)+margin.left)
        .attr('x2', x(year)+margin.right)
        .attr('y1', 50)
        .attr('y2', height+50)
      tooltip.html('Year: ' + year)
        .style('display', 'block')
        .style('background', 'white')
        .style('left', d3.event.pageX + 10)
        .style('top', d3.event.pageY - 50)
        .selectAll()
        .data(fuel).enter()
        .append('div')
        .style('color', d => d["color"])
        .html((d) => {
          var item = d.history.find(d => d.year === year)
          if (item) {
            return ' ' + d.name + ': ' + d3.format(",.2r")(item.emission/Math.pow(10,power)) + ' ' + sign
          } else {
            return ' ' + d.name + ': ' + 0 + ' ' + sign
          }
        })
    }
  }
</script>

<script>
  chart_one = () => {
    var svg = d3.select("#chart-1")
    const tooltip = d3.select('#tooltip')
    const tooltipLine = svg.append('line')
    const margin = {top:50, right:100, bottom:50, left:100}
    const width = svg.attr("width") - margin.left - margin.right
    const height = svg.attr("height") - margin.top - margin.bottom
    const x = d3.scaleLinear().range([0, width])
    const y = d3.scaleLinear().range([height, 0])

    svg.append("text")
    .attr("transform", "translate(" + (width/2+margin.left) + " ," + 30 + ")")
    .style("text-anchor", "middle")
    .style("font", "20px avenir")
    .text("CO2 Emissions By Fuel, World")

    const line = d3.line().x(d => margin.left + x(d.year)).y(d => margin.bottom + y(d.emission)).curve(d3.curveMonotoneX)

    var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    let fuel, tipBox
    d3.csv("data/co2-emissions-by-fuel-line.csv").then((data) => {
      fuel = [
        {"type":"Oil","color":"#B10DC9","currentEmission":0,"history":[]},
        {"type":"Coal","color":"#0000CD","currentEmission":0,"history":[]},
        {"type":"Gas","color":"#FF4500","currentEmission":0,"history":[]}
      ]
      data.forEach((d, i) => {
        if (d["code"] == "OWID_WRL" && Number(d["year"]) >= 1900) {
          fuel[0]["history"].push({
            "year":Number(d["year"]),
            "emission":Number(d["oil"]),
          })
          fuel[1]["history"].push({
            "year":Number(d["year"]),
            "emission":Number(d["coal"]),
          })
          fuel[2]["history"].push({
            "year":Number(d["year"]),
            "emission":Number(d["gas"]),
          })
          fuel[0]["currentEmission"] = Number(d["oil"])
          fuel[1]["currentEmission"] = Number(d["coal"])
          fuel[2]["currentEmission"] = Number(d["gas"])
        }
      })
      // domains
      x.domain([d3.min(fuel[0]["history"], (d) => {return d["year"]}),d3.max(fuel[0]["history"], (d) => {return d["year"]})])
      y.domain([0,d3.max(fuel, (d) => { return  d3.max(d["history"], (d) => {return d["emission"]}) })])
      // populate x axis labels
      g.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x).tickValues([1900,1925,1950,1975,2000,2018]).tickFormat(d3.format("d")))
      // text label for the x axis
      svg.append("text")
      .attr("transform", "translate(" + (width/2+margin.left) + " ," + (height + 2*margin.top) + ")")
      .style("text-anchor", "middle")
      .style("font", "16px avenir")
      .text("Year")
      // populate y axis labels
      g.append("g")
      .call(d3.axisLeft(y).tickFormat((d) => {return d/1000000000 + " bln"}))
      // draw line
      svg.selectAll()
        .data(fuel).enter()
        .append('path')
        .attr('fill', 'none')
        .attr('stroke', d => d["color"])
        .attr('stroke-width', 2)
        .datum(d => d["history"])
        .attr('d', line)
      // add type of fuel
      svg.selectAll()
        .data(fuel).enter()
        .append('text')
        .html(d => d["type"])
        .attr('fill', d => d["color"])
        .attr('alignment-baseline', 'middle')
        .attr('x', width + margin.left)
        .attr('dx', '.5em')
        .attr('y', d => margin.bottom  + y(d["currentEmission"]))
      // add type of tipBox
      tipBox = svg.append('rect')
        .attr('x',margin.left)
        .attr('y',margin.bottom)
        .attr('width', width)
        .attr('height', height)
        .attr('opacity', 0)
        .on('mousemove', drawTooltip)
        .on('mouseout', removeTooltip)
    })
    removeTooltip = () => {
      if (tooltip) tooltip.style('display', 'none');
      if (tooltipLine) tooltipLine.attr('stroke', 'none');
    }
    drawTooltip = () => {
      const year = Math.ceil(x.invert(d3.mouse(tipBox.node())[0]-margin.left))
      fuel.sort((a, b) => {
        return b.history.find(h => h.year == year).emission - a.history.find(h => h.year == year).emission;
      })
      tooltipLine.attr('stroke', 'lightgrey')
        .attr('x1', x(year)+margin.left)
        .attr('x2', x(year)+margin.right)
        .attr('y1', 50)
        .attr('y2', height+50);
      tooltip.html('Year: ' + year)
        .style('display', 'block')
        .style('background', 'white')
        .style('left', d3.event.pageX + 10)
        .style('top', d3.event.pageY - 50)
        .selectAll()
        .data(fuel).enter()
        .append('div')
        .style('color', d => d.color)
        .html((d) => {
          return ' ' + d.type + ': ' + d3.format(".1f")(d.history.find(h => h.year == year).emission/1000000000) + ' bln tons'
        });
    }
  }
</script>
</html>
